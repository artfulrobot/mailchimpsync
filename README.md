# mailchimpsync
CiviCRM Extension providing Mailchimp Sync

Oh no! We're here again!

There are currently three mailchimp-sync extensions

1. <https://civicrm.org/extensions/mailchimp-civicrm-integration> - most popular one. Maintained by Veda, although not very actively (last release 2017). I wrote the majority of this code when Mailchimp ditched v2 of their API.
2. <https://civicrm.org/extensions/mailchimp-sync> not updated since 2014. Uses deprecated Mailchimp API.
3. <https://civicrm.org/extensions/civimailchimp> not updated since 2015. Uses deprecated Mailchimp API.

2, 3 are dead as I understand as they use an out of date Mailchimp API. 1 works but it struggles with big lists and it struggles with build updates.

I'm proposing a new Mailchimp sync based on my experience of writing/using (1), and possibly with a couple of ideas used by (3).

## Benefits

* Proper 2 way, automated sync of membership data. i.e. away from "civi is always right" or "mailchimp is always right"; you can upload/remove contacts at either end and it will figure out what to do for each contact.

* More reliable and flexible data sharing between MC and Civi through some sensible rules.

* Activities flag potential problems like contacts that CiviMail wouldn't email.

## Concepts

1. You link a Mailchimp Audience (List) to a CiviCRM Mailing Group. I'm calling this the *subscription group*. Briefly:
   - 'subscribed' (or 'pending') at Mailchimp = 'Added' in the CiviCRM group
   - 'unsubscribed' at Mailchimp = 'Removed' in the CiviCRM group.

2. The CiviCRM subscription group **is not a smart group**. Reason being that we rely on the timestamp field from the subscription history table; this does not exist for smart groups.

3. Changes to Mailchimp run **asynchronously**, by Scheduled Jobs.

4. Two way sync: Changes in subscriptions are handled incrementally by using last updated timestamps from CiviCRM and Mailchimp data to determins the winner.

5. Extra data either belongs to CiviCRM or to Mailchimp and is one-way only.

6. Extra data can be pushed to Mailchimp from CiviCRM separately to the subscription sync and will use Mailchimp's bulk API. e.g. it might run nightly. In v1 I propose that this data is generated by hooks implemented in other extensions. In future versions we might have a UI for selecting arbitrary data and mapping it to Mailchimp data constructs.

7. Extra data can be pulled to CiviCRM from Mailchimp in a separate operation. I propose not to implement this in v1.

8. Data syncs can be selective - e.g. use a "needs update on Mailchimp" group and add contacts into that when you know their data needs updating, e.g. after adding a contribution. This enables a faster job that it would be more feasible to run more frequently.

9. The sync will never un-delete a contact.

10.When first adding a contact to Mailchimp, it will choose a non-on-hold Bulk email, then a non-on-hold Primary email. This seemed like a good idea taken from one of the other extensions, since it allows storing email addresses that will never be given to Mailchimp. Note that subsequent changes to an email's metadata have no effect, though.

11. We only look at group membership. We ignore the following list of things:

  * No bulk mail

  * Do not email

  * Deceased contacts

  * Deleted contacts

  * On hold email addresses

  These should be handled outside of the sync situation; e.g. remove people from group in the above situations. The sync code will, however, prefer contacts that the above does not apply to and should (optionially?) flag up this stuff if found.


## Config

* Mailchimp accounts screen (allows setting up potentially multiple MC accounts - single account in v1.)

* Mailchimp account status screen shows status of any long-running bulk update jobs (v2: cancel job?)

* Multiple audiences/lists mapped to CiviCRM groups (screen lists them and allows adding them)

* Each audience can have data mapping (v1. via hooks only)

* v2? Include auto processing options: deceased;no bulk mail;do not email → remove from mailing group(s)



## Subscription sync

CiviCRM *maintains* a copy of mailchimp data.

* Mailchimp: member hash

* Mailchimp: email

* Mailchimp: status (subscribed/unsubscribed/deleted)

* Mailchimp: `last_updated`

* Mailchimp: hash of data CiviCRM supplied last time

* Mailchimp: json object of data we care about?

* CiviCRM Contact ID

* CiviCRM status

* CiviCRM data object (to be mapped to mailchimp in data sync)

* CiviCRM data hash 


### Membership Sync Algorithm

1. load from Mailchimp since last fetch date (or all data if that option set, e.g. for initial sync).

2. merge that data into the copy table. (CiviCRM Contact Id will be left NULL for new data)

3. re-generate all CiviCRM group membership data:

   1. Contact ID

   2. status

   3. date from subscription history table

   4. Copy No Bulk Email; Opt Out?; is deleted.

   5. May result in rows that have null Mailchimp data.

4. Ensure CiviCRM contact Ids exist:

   1. If they belong to `is_deleted` contacts set them to NULL (case: merged contacts; setting null here will force it to look for another contact with that email)

   2. if the contact no longer exists, set it to NULL (could be done by FK)

   3. for all NULL contacts Look up by email. In the following we use the first one, if multiple exist:

      1. If there's one that's not deleted and is in the group, use that (first by contact ID)  → step 5

      2. If there's one that's not deleted and was in the group, use that (first by contact ID)   → step 5

      3. If there's a deleted one that's in the group, use that (first by contact ID)   → step 5

      4. If there's a deleted one was in the group, use that (first by contact ID)  → step 5

      5. If there's a not deleted contact, use that → step 5

         (at this point remaining found contacts are deleted, or there aren't any)

      6. If contact is subscribed at MC, treat as new contact because we can't undelete a contact. **Create contact**   → step 5

      7. If contact is not subscribed at MC, use first deleted contact.

      8. If still no contact ID, **create contact** → step 5

5. Process all contacts with group updated dates >= cutoff (i.e. datetime of last successful sync) as follows:

6. For contacts where Mailchimp is more up-to-date than Civi (inc. newly created contacts):

   1. Subscribed at both? noop

   2. Subscribed at MC but removed or not in group at all at Civi? Add to group. Warn if contact deleted; on hold etc.

   3. Unsubscribed/deleted at MC and added in Civi? Remove from group.

   4. Unsubscribed/deleted at MC and removed/not present in Civi? noop

7. For contacts where Civi is more up-to-date than Mailchimp (inc. non existent at MC):

   1. Added in Civi?

      1. Subscribed in MC? noop

      2. Deleted in Mailchimp? Impossible to subscribe: flag it unless already flagged.

      3. Unsubscribed in Mailchimp? If poss: was it by them? if so set pending; otherwise set subscribed. Change Mailchimp status in our copy table accordingly.

      4. Not in Mailchimp? create new subscriber. Change Mailchimp status to subscribed.

   2. Removed in Civi

      1. Unsubscribed/deleted/not existent in Mailchimp? noop

      2. Subscribed in Mailchimp? Set unsubscribed in Mailchimp.

8. At this point we should have an array of subscription changes at Mailchimp.

## Data sync

A data sync begins with a membership sync (because it's important the membership data is up-to-date), but then goes on to pass additional data to Mailchimp.

1. Gather all extra data from CiviCRM for all 'subscribed' (or 'pending') in the Mailchimp status; store this in the table. This is hookable so local installs can add extra data as they wish (e.g. last donation amount or such).

2. Compute the hash of this new data with the hash stored from last time. Where hashes mismatch:

   1. Create a bulk update for Mailchimp where hashes mismatch.

   2. Store the new hash

This should be able to be run for a particular subset of the group. e.g. subscription group: X; subset: group Y, where group Y could be a "needs Mailchimp update" group that people/systems could add people to when they know the data needs update (e.g. on adding a contribution).

## Webhook

Auto-configure (after confirmation) Mailchimp audiences with webhooks that handle unsubscribe, subscribes, data changes.

v1: This allows updating CiviCRM immediately-ish (webhooks don't fire in real time). Since we have a frequently running incremental cron job handling membership sync, this probably does not add much benefit. However, this could be useful for handling email changes (v2?).

I'm undecided about the role of webhooks. They can be troublesome but have their uses.

## Comments - please use issue queue


I'd love to hear your thoughts.

