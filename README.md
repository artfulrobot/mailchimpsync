# mailchimpsync

CiviCRM Extension providing Mailchimp Sync

Oh no! We're here again!

There are currently three mailchimp-sync extensions

1. <https://civicrm.org/extensions/mailchimp-civicrm-integration> - most popular one. Maintained by Veda, although not very actively (last release 2017). I wrote the majority of this code when Mailchimp ditched v2 of their API.
2. <https://civicrm.org/extensions/mailchimp-sync> not updated since 2014. Uses deprecated Mailchimp API.
3. <https://civicrm.org/extensions/civimailchimp> not updated since 2015. Uses deprecated Mailchimp API.

2, 3 are dead as I understand as they use an out of date Mailchimp API. 1 works but it struggles with big lists and what to do when data is changed at both ends between syncs. I'm proposing a new Mailchimp sync based on my experience of writing/using (1), and possibly with a couple of ideas used by (3).

## Benefits

* Proper 2 way, automated sync of membership data. i.e. away from "civi is always right" or "mailchimp is always right"; you can upload/remove contacts at either end and it will figure out what to do for each contact.

* More reliable and flexible data sharing between MC and Civi through some sensible rules.

* Activities flag potential problems like contacts that CiviMail wouldn't email.

## Concepts

1. You link a Mailchimp Audience (List) to a CiviCRM Mailing Group. I'm calling this the *subscription group*. Briefly:
   - 'subscribed' (or 'pending') at Mailchimp = 'Added' in the CiviCRM group
   - 'unsubscribed' at Mailchimp = 'Removed' in the CiviCRM group.

2. The CiviCRM subscription group **is not a smart group**. Reason being that we rely on the timestamp field from the subscription history table; this does not exist for smart groups.

3. Changes to Mailchimp run **asynchronously**, by Scheduled Jobs.

4. Two way sync: Changes in subscriptions are handled incrementally by using last updated timestamps from CiviCRM and Mailchimp data to determins the winner.

5. Extra data either belongs to CiviCRM or to Mailchimp and is one-way only.

6. Extra data can be pushed to Mailchimp from CiviCRM separately to the subscription sync and will use Mailchimp's bulk API. e.g. it might run nightly. In v1 I propose that this data is generated by hooks implemented in other extensions. In future versions we might have a UI for selecting arbitrary data and mapping it to Mailchimp data constructs.

7. Extra data can be pulled to CiviCRM from Mailchimp in a separate operation. I propose not to implement this in v1.

8. Data syncs can be selective - e.g. use a "needs update on Mailchimp" group and add contacts into that when you know their data needs updating, e.g. after adding a contribution. This enables a faster job that it would be more feasible to run more frequently.

9. The sync will never un-delete a contact.

10. When first adding a contact to Mailchimp, it will choose a non-on-hold Bulk email, then a non-on-hold Primary email. This seemed like a good idea taken from one of the other extensions, since it allows storing email addresses that will never be given to Mailchimp. Note that subsequent changes to an email's metadata have no effect, though.

11. We only look at group membership. We ignore the following list of things:

  * No bulk mail

  * Do not email

  * Deceased contacts

  * Deleted contacts

  * On hold email addresses

  These should be handled outside of the sync situation; e.g. remove people from group in the above situations. The sync code will, however, prefer contacts that the above does not apply to and should (optionially?) flag up this stuff if found.


## Config

* Mailchimp accounts screen (allows setting up potentially multiple MC accounts - single account in v1.)

* Mailchimp account status screen shows status of any long-running bulk update jobs (v2: cancel job?)

* Multiple audiences/lists mapped to CiviCRM groups (screen lists them and allows adding them)

* Each audience can have data mapping (v1. via hooks only)

* v2? Include auto processing options: deceased;no bulk mail;do not email → remove from mailing group(s)



## Subscription sync

CiviCRM *maintains* a copy of mailchimp data, per audience.

* Mailchimp: audience (ID string)

* Mailchimp: member hash

* Mailchimp: email

* Mailchimp: status (subscribed/unsubscribed/deleted)

* Mailchimp: `last_updated`

* Mailchimp: hash of data CiviCRM supplied last time

* Mailchimp: json object of data we care about?

* CiviCRM Contact ID

* CiviCRM status

* CiviCRM data object (to be mapped to mailchimp in data sync)

* CiviCRM data hash


### Membership Sync Algorithm

1. load from Mailchimp since last fetch date (or all data if that option set, e.g. for initial sync).

2. merge that data into the copy table. (CiviCRM Contact Id will be left NULL for new data)

3. re-generate all CiviCRM group membership data:

   1. Contact ID

   2. status

   3. date from subscription history table

   4. Copy No Bulk Email; Opt Out?; is deleted.

   5. May result in rows that have null Mailchimp data.

4. Ensure CiviCRM contact Ids exist:

   1. If they belong to `is_deleted` contacts set them to NULL (case: merged contacts; setting null here will force it to look for another contact with that email)

   2. if the contact no longer exists, set it to NULL (could be done by FK)

   3. for all NULL contacts Look up by email. In the following we use the first one, if multiple exist:

      1. If there's one that's not deleted and is in the group, use that (first by contact ID)  → step 5

      2. If there's one that's not deleted and was in the group, use that (first by contact ID)   → step 5

      3. If there's a deleted one that's in the group, use that (first by contact ID)   → step 5

      4. If there's a deleted one was in the group, use that (first by contact ID)  → step 5

      5. If there's a not deleted contact, use that → step 5

         (at this point remaining found contacts are deleted, or there aren't any)

      6. If contact is subscribed at MC, treat as new contact because we can't undelete a contact. **Create contact**   → step 5

      7. If contact is not subscribed at MC, use first deleted contact.

      8. If still no contact ID, **create contact** → step 5

5. Process all contacts with group updated dates >= cutoff (i.e. datetime of last successful sync) as follows:

6. For contacts where Mailchimp is more up-to-date than Civi (inc. newly created contacts):

   1. Subscribed at both? noop

   2. Subscribed at MC but removed or not in group at all at Civi? Add to group. Warn if contact deleted; on hold etc.

   3. Unsubscribed/deleted at MC and added in Civi? Remove from group.

   4. Unsubscribed/deleted at MC and removed/not present in Civi? noop

7. For contacts where Civi is more up-to-date than Mailchimp (inc. non existent at MC):

   1. Added in Civi?

      1. Subscribed in MC? noop

      2. Deleted in Mailchimp? Impossible to subscribe: flag it unless already flagged.

      3. Unsubscribed in Mailchimp? If poss: was it by them? if so set pending; otherwise set subscribed. Change Mailchimp status in our copy table accordingly.

      4. Not in Mailchimp? create new subscriber. Change Mailchimp status to subscribed.

   2. Removed in Civi

      1. Unsubscribed/deleted/not existent in Mailchimp? noop

      2. Subscribed in Mailchimp? Set unsubscribed in Mailchimp.

8. At this point we should have an array of subscription changes at Mailchimp.

## Data sync

A data sync begins with a membership sync (because it's important the membership data is up-to-date), but then goes on to pass additional data to Mailchimp.

1. Gather all extra data from CiviCRM for all 'subscribed' (or 'pending') in the Mailchimp status; store this in the table. This is hookable so local installs can add extra data as they wish (e.g. last donation amount or such).

2. Compute the hash of this new data with the hash stored from last time. Where hashes mismatch:

   1. Create a bulk update for Mailchimp where hashes mismatch.

   2. Store the new hash

This should be able to be run for a particular subset of the group. e.g. subscription group: X; subset: group Y, where group Y could be a "needs Mailchimp update" group that people/systems could add people to when they know the data needs update (e.g. on adding a contribution).

## Webhook

Auto-configure (after confirmation) Mailchimp audiences with webhooks that handle unsubscribe, subscribes, data changes.

v1: This allows updating CiviCRM immediately-ish (webhooks don't fire in real time). Since we have a frequently running incremental cron job handling membership sync, this probably does not add much benefit. However, this could be useful for handling email changes (v2?).

I'm undecided about the role of webhooks. They can be troublesome but have their uses.

## If you can, don't use Mailchimp!

In working with the API and the documentation over the last 8 years or so I've found several bugs, reported them, had them acknowledged with a promise of passing it on, yet nothing happens. They've also changed things without publishing the changes. Mailchimp's [API Reference](https://developer.mailchimp.com/documentation/mailchimp/reference/overview/) does not give a complete picture of the service. All this makes integration extensions brittle.

Another issue is that there is no sandbox development environment; everything must be done with real email addresses and real paid-for services. This has several risks and pitfalls: accidents can be costly and testing email addresses can trigger security alerts ("foo@example.com" has subscirbed too much recently, request denied). Data cannot be properly deleted; if you delete an email address it is *stored* as deleted for the purposes of remembering to never use it again. This means you need an infinite source of dummy addresses for testing.

Seems the customers have not found a way to apply enough pressure collectively to improve their product. Humph.

All this is a good reason to persuade people not to use Mailchimp at all if feasible. CiviCRM + Mosaico gives a descent experience for 80% of use cases and gives you more segmentation flexibility and usually much lower cost.

## Understanding Mailchimp's data structures, intended use, API

Mailchimp seem to be strongly pushing the idea of one "Audience" (previously "List") for all subscribers and then segmenting according to various data for sending email "Campaigns". The UI (September 2019) refers to singluar "Audience" and will even hide the audience selector unless you have already created several. On a free account you're only allowed a single Audience.

> If you can, it's best to have one audience that you organize with tags, groups, or segments, rather than maintain multiple audiences in your account. Mailchimp treats all the audiences in your account separately, and billing is based on the total number of subscribed contacts across all your audiences. If you have duplicate contacts across audiences, having one audience could save you money. One audience is also easier to manage and keep clean.
>
> [Source: Mailchimp: Best practices](https://mailchimp.com/help/requirements-best-practices-audiences/)

The extension should support multiple audiences but users should keep in mind it's not "the mailchimp way", so should probably not use it like that.

Annoyingly, of course, this means that the unsubscribe link covers all purposes. e.g. if you have one audience and within it you have 'major donors' and 'daily newsletter' segments, a major donor who thinks they're unsubscribing from the daily newsletter removes themselves from the important major donors segment, too. Mailchimp provide their own forms for "updating preferences" but who among us, when faced with wanting to unsubscribe, fancies interacting with an unknown and probably awkward profile update form when there's an unsubscribe link right next to it?

Audience members are categorised as follows ([source Sep 2019](https://mailchimp.com/help/getting-started-audience/)):

> - **Subscribed contact** Someone who has opted in to receive your email marketing campaigns.
> - **Unsubscribed contact** Someone who was opted in to receive your email marketing campaigns, but isn't currently.
> - **Non-subscribed contact** Someone who has interacted with your online store, but hasn't opted in to receive your email marketing campaigns.

The API, however, returns one of these statuses

* **subscribed**
* **unsubscribed** 
   - if done by the member via a Mailchimp unsubscribe link you can't resubscribe them via API (but you can set "pending").
   - if done via the API, or the UI, you can resubscribe them. Mailchimp does not send a confirmation email or unsubscribe notice.
* **cleaned** (removed by Mailchimp due to bounces)
* **pending** - Mailchimp will send an email to them requiring them to confirm subscription.
* **transactional** ?? no reference to this in the API or other documenation, perhaps it means "non-subscribed contact"
* **archived** [documentation](https://mailchimp.com/help/archive-unarchive-contacts/). An archived contact is not billed-for and you can't interact with their data in any way except to un-archive them. If they were to resubscribe using a Mailchimp form they become un-archived. In the UI un-archiving restores the original status, but in the API there does not seem to be the equivalent method - you have to choose one of these.

## How to 'unsusbscribe'

If someone leaves the group in CiviCRM that syncs with an audience's membership, we have several options:

- delete the member. No! This makes it impossible for us to resubscribe them via the API at all.
- unsubscribe the member. This is reversible via API.
- archive the member. This is reversible.

What's the difference between unsubscribe and archive? Neither is billed. Unsubscribed represents the intent of the person better an archived contact that is un-archived (via UI) would become subscribed again. So it still looks sensible to use unsubscribe.

If the person uses a Mailchimp unsubscribe link, we need to remove the contact from our CiviCRM group. Note that we won't be able to resubscribe them directly from the API - the first call will fail and we need to detect this and try again with 'pending'. **Q. is there a way to detect before the fail?** (would solve issue of not getting feedback from bulk updates)

## Segmentation

Because of the focus on a single audience we need to handle not just the complete unsubscribe-from-everything situation, but also the "update preferences". This means we need a 2 way sync on something other than list membership.

Previous extensions have used Mailchimp's **Interest Groupings** for this (ambiguously called "Groups" in mailchimp). Mailchimp allows groupings of groups (Drupal users: think vocabularies of terms) that are binary yes-or-no for a contact. **This seems pretty sensible still.**

Since them Mailchimp has introduced **Tags**, but these are for "internal use" ([source](https://mailchimp.com/help/getting-started-tags/)); they're not editable by contacts themselves using Mailchimp preference forms. Therefore these do not seem like a sensible way to do most segmentation whereby people can 'unsubscribe' from a segment without unsubscribing from whole audience.

Previous extensions used CiviCRM groups mapped to interest groups for this. An
alternative is CiviCRM Tags. e.g. mirror Mailchimp's interests with tags (could
even be automated). But tags have no metadata and no history, so groups will
still be needed, especially for determining which source has most recently been
updated.

We ought to look at the group subscription history date in CiviCRM on a per
group basis and compare it against the lastest update date for the Mailchimp
contact.

There is still the case where:

1. Contact is in sync and is in subscription group (is subscribed in audience);
   and is in interest group A but not B.

2. Staff member adds them to group B in CiviCRM.

3. Contact updates via mailchimp UI interests, removing themself from group A.
   They do this before a sync has happened.

4. Mailchimp only gives us a last updated date for the contact, not per group.
   As here Mailchimp's last update will be later than our group updates, it will
   win and we will lose data.

   - Group A: Mailchimp's data wins: remove from CiviCRM group. This is fine.

   - Group B: Mailchimp's data wins: remove them from CiviCRM group!

(Note this can be avoided if 2, 3 are swapped in time.)

This can be minimised but not completely mitigated by frequent syncs. I think
this reduces the chance of it happening to 'not at all likely' but users would
need to understand the risk for their particular use.

## Smart and Hierarchical groups

Smart groups are not allowed to be used for subscriptions or interests because
there's no subscription history records for them, and we need to know when the
contact was added/removed from a group.

CiviCRM allows hierarchical groups. In summary the logic is "a contact is in a
group if it is included in any child (or grand child etc.) group".

At first I thought this would be a logical configuration for addressing interest
groups within a subscription group (audience).

However the way this is implemented opens up a lot of confusion. The sentence
stating the logic above is true for searches, but apparently not true if you
inspect a single contact's record - the parent group(s) are not listed, even if
you look under Smart Groups. It's also confusing because if you Remove your
contact from the parent group (by manually *adding* then *removing* them),
they're still considered to be in the group if they are in a child group; the
only way to remove someone from a parent group is to remove from all child
groups.

This is way too complex to use sensibly (consider case that a contact is
'Removed' in CiviCRM from main subscription group but is still Added to a child
group. The sync would see subscription history for the removal, but would have
to know to ignore that by doing a search on child groups).

Therefore this extension requires that subscription/interest groups are not
hierarchical.

## Comments - please use issue queue


I'd love to hear your thoughts.


